# 💼 RAKUSHIRU Cloud UX要件定義書（RDD）

> ステータス: 参考資料（初期のUX要件定義）。最新仕様は各 `README_*.md` と `docs/PROGRESS.md` を優先。

---

## 1. プロダクト概要
RAKUSHIRU Cloud は、**見積・請求業務を Money Forward クラウド請求書と連携**させる社内向けワークフローアプリです。  
ユーザーは Web ブラウザ上で見積の作成〜承認〜請求化までを完了でき、必要に応じて Money Forward 上のデータ同期や PDF 閲覧を行います。

### 🔗 システム連携の概要
- **PDF化・メール送信・印刷・顧客管理の一部**については **Money Forward 請求書API** を利用。  
- 顧客の基本データベースは **日報管理システム（XeroPM など）とAPI連携**し、常に最新の顧客情報を同期。  
- 顧客データのマスターは日報システム側で一元管理し、RAKUSHIRU Cloud 側は参照・同期のみ行う。

---

## 2. 想定ユーザー

| ロール | 主な操作 |
|---------|-----------|
| **営業担当者** | 見積作成・編集・申請、請求書ドラフト作成 |
| **承認者 / 管理者** | 見積承認、承認履歴の確認、ダッシュボードでのタスク管理 |
| **経理担当者** | Money Forward 同期の確認、請求書 PDF や金額情報のチェック |

---

## 3. 全体的な UX 要件

- Money Forward 連携時に OAuth 認証が発生する場合は、**画面上で導線を明確に提示**する。  
- 見積・請求のステータスや同期状態は、**ラベル・バナー表示で即時確認可能**とする。  
- 承認フローは **最小限の操作**で再申請や承認取り消しができるようにし、ダイアログやトーストで結果を通知する。  
- 金額・日付は日本語ローカライズ形式で表示し、**date picker / month picker** で入力補助を行う。  
- Money Forward 側で削除・編集されたデータは、**次回同期で反映・除外**され、ユーザーが混乱しないようにする。  

---

## 4. 主要画面別のユーザー体験

### 4.1 ログイン画面
- Breeze/Jetstream ベースの標準ログイン（メール＋パスワード）  
- ログイン後はダッシュボードに遷移  

---

### 4.2 ダッシュボード
- **やることリスト**: 承認待ち見積を最新順に表示。次の承認者には「確認して承認」ボタンを表示  
- **取引先自動同期**: ダッシュボード表示直後に Money Forward の取引先同期をトリガー。未認証の場合は OAuth へ遷移し、復帰後に同期結果を画面上に専用メッセージとして表示  
- **取引先取得ボタン**: 手動で再同期したい場合に使用。OAuth 認証経由で取引先・部門を同期（成功/失敗はダッシュボード内のメッセージに表示）  
- **KPIカード**: 現状はダミー値、UI確認用として配置  

---

### 4.3 見積一覧 `/quotes`
- フィルタ機能：件名・顧客名・ステータス・発行月で絞り込み  
- 同期状態バナーで「最終同期時刻」「認証要求」等を表示  
- 行操作：詳細／編集／複製／プレビュー（HTML）／削除  
- 一括操作：承認申請・担当者付替（ダミー）  
- 「見積同期」ボタンで Money Forward の見積一覧を取り込み、ローカルIDと紐付け  

---

### 4.4 見積編集 `/estimates/{id}/edit`
- **必須項目**: 顧客・部門・担当者・件名・発行日・明細  
- 明細行: shadcn UI により追加／削除／並び替え対応  

#### 承認フロー
- 「承認申請」ダイアログで承認者設定・並び替え  
- 申請後 → `pending` 状態へ遷移、「申請取消」ボタン表示  
- 再申請時 → 承認履歴リセット、再承認可能  

#### Money Forward 連携ボタン（承認済のみ表示）
- 見積書発行 → OAuth → API連携 → `mf_quote_id` 保存  
- 請求変換 → MF見積→請求変換API → `mf_invoice_id` 保存  
- PDF表示 → OAuth経由でストリーミング  
- 請求書確認 → `mf_invoice_pdf_url` に直接遷移  

保存後はフラッシュメッセージで通知。

---

### 4.5 見積承認フロー
- 承認者は詳細シートまたはダッシュボードから承認画面へ  
- 承認ボタン押下で承認処理  
- 全承認完了 → ステータス `sent` に更新  
- 再申請後 → 承認リストが再び `pending` に戻る  

---

### 4.6 請求書一覧 `/billing`
- Money Forward請求＋ローカル請求を統合表示  
- フィルタ: 請求月From/To、タイトル、取引先、支払ステータス  
- 同期バナーで最新同期／認証エラーを表示  
- MF請求: 編集／PDFリンクを提供  
- ローカル請求: 「MF未生成」「PDF」「→MF」などのアクションを状態別に表示  
- PDFリンク押下 → OAuth → PDFダウンロードフォールバック  

---

### 4.7 ローカル請求編集 `/invoices/{id}/edit`
- 見積から生成された請求ドラフトを編集可能  
- 明細編集と合計再計算を自動処理  

#### Money Forward送信
- 保存後、OAuthで `invoice_template_billings` API 呼び出し  
- 成功時: `mf_billing_id` / `mf_pdf_url` 保存 → ローカル請求をロック  
- PDF閲覧: トークン有効時は即時表示、期限切れはOAuth再実行  

---

### 4.8 請求書新規作成 `/billing/create`
- 現在は「開発中です」メッセージのみ表示  

---

### 4.9 商品マスタ `/products`
- 一覧: 名前・SKU・分類・税区分を表示、検索対応  
- 分類管理: shadcn Dialogで追加／編集／削除（制約未実装）  
- 新規作成／編集: SKU 自動生成（例: `<分類コード>-001`）  

#### Money Forward同期
- 画面表示時にローカル商品マスタを Money Forward へ自動同期（作成・更新・削除を差分処理）  
- 「MFへ同期」ボタンで同じ処理を手動再実行  
- 行単位の同期ボタンは廃止し、差分同期に集約  

---

### 4.10 取引先同期
- 「取引先取得」押下 → OAuth → MF API呼び出し → partnersテーブル保存  
- 編集画面では `/api/partners/{partner}/departments` から候補取得  

---

### 4.11 在庫管理 `/inventory`
- モックデータでUI確認用（実データ連携は未実装）  

---

### 4.12 Salesページ
- 旧売掛管理画面。ナビゲーション非表示。未使用／未完成。  

---

## 5. Money Forward 連携に関する UX

| フロー | 状態遷移 | ユーザー通知 |
|---------|-----------|----------------|
| OAuth認証 | 認証ボタン → MFログイン → コールバックでトークン保存 | 成功: トースト「認証完了」<br>失敗: エラーバナー |
| データ同期（見積/請求） | 「同期中」バナー表示。前回同期時刻を表示 | エラー内容をフラッシュで通知 |
| 見積書発行/請求変換 | 完了後は成功トースト＋ボタン切替 | 失敗時は `error_description` を表示 |
| PDF表示 | トークン有効時: 即時ダウンロード<br>無効時: OAuth再実行 | エラー時はエラートースト表示 |

---

## 6. 未完成・将来対応予定
- 請求書新規作成画面（開発中）  
- Inventory 管理画面（モックのみ）  
- Sales ページ（旧画面、非使用）  
- ダッシュボード指標はダミー値 → 実運用に合わせ要実装  

---

## 7. ユーザー体験の品質指標

- **整合性**：MFデータ更新（編集・削除）は同期後に確実に反映されること  
- **再申請フロー**：承認済み見積の再申請でステータスが確実に「承認待ち」に戻ること  
- **操作フィードバック**：主要操作にはトーストやダイアログで明確な結果通知  
- **入力補助**：日付・金額などのバリデーション即時表示  
- **エラーハンドリング**：MF API エラーはわかりやすく提示（例: 403 権限不足）  

---

## 8. 依存サービスと前提条件
- Money Forward クラウド請求書の開発者アカウントとアプリ設定（Client ID/Secret, Redirect URI）  
- OAuth スコープ：`mfc/invoice/data.read`・`mfc/invoice/data.write`  
- `.env` 設定済み、Laravelサーバー・npmビルド起動が前提  
- 顧客マスターは **日報管理システム API との連携前提**。RAKUSHIRU 側では編集不可・参照のみ。  

---

## 9. 今後の検討項目
- ダッシュボードKPIカードの実データ化  
- Inventory CRUD 実装  
- 請求書新規作成画面の機能追加  
- 承認フロー通知（メールGoogle Chat）設計  
- Money Forward 差分同期・失敗リトライ通知の改善  
- 日報管理システムとの双方向同期（顧客・担当者・案件情報の統合化）  

---
