# 営業訪問前AIコーチ 仕様

実装ベースの最新仕様。これだけ読めば開発・運用ができるように記載。

## 背景と目的
- 顧客訪問前に新人営業が「何を聞くか迷う」を防ぎ、要件抜け・手戻りを減らす。
- AIがゴール確認→優先質問提示→質問リライト→印刷用アジェンダ生成を支援。
- 販売管理（MFクラウド請求書連携周辺）を主対象。PGが設計・見積に入れる粒度で情報を揃える。

## 機能概要
- ゴール入力 + コンテキスト入力（URL/要約）。URLならサーバ側で本文をフェッチしプロンプトに含める（5秒/20KB上限、失敗時は警告＋元テキストでフォールバック）。
- 優先質問をAI生成（件数上限なし）。AI応答から「やる/やらない」案も取得。
- デフォルト観点をシステムプロンプトに内蔵（帳票/印刷、承認/権限、在庫/購買、請求/会計、非機能/運用）。カスタムプロンプトを追記可能（ベースは残る）。
- 質問リライト: Yes/Noで終わる質問を「現状→理想→制約→例外→優先」に言い換え。
- 1ページ要約（ドラフト）: ゴール、やる/やらない、未決事項を入力し、印刷ボタンでアジェンダ部分だけ印刷。
- 使い方ガイドページ（`/sales-ai-coach/guide`）で要件定義の解説を提供（管理者以外も閲覧可）。
- ベースプロンプト設定ページ（管理者のみ）でシステムプロンプトに追記するカスタム文を保存。

## 画面/ルート
- `/sales-ai-coach` … メイン画面（誰でもアクセス可）。ヘッダーに「使い方」、管理者のみ「設定」ボタン。
- `/sales-ai-coach/guide` … 使い方・要件定義ガイド（全ユーザ）。
- `/sales-ai-coach/settings` … ベースプロンプト設定（ユーザID 3:守部幸洋、8:川口大希 のみ）。最新の設定を採用。
- `/sales-ai-coach/generate` (POST) … ゴール/コンテキストを受け取りAI生成。

## 入出力（現在のUI）
- 入力: ゴール（必須）、コンテキスト（任意、URL可）。質問案（リライト対象）、やる/やらない、未決事項。
- 出力:
  - 優先質問（AI提案、0件ならデフォルトテンプレ）。
  - やる/やらない（AI応答の actions.do/dont を自動反映、未入力なら手動入力も可）。
  - 未決事項（手動入力）。
  - 印刷用アジェンダ（ゴール/コンテキスト/質問/やる・やらない/未決事項）。次アクションは訪問後記入のため未表示。
  - リライト結果（深掘り版の例文を表示）。

## バックエンド仕様
- コントローラ: `app/Http/Controllers/SalesAiCoachController.php`
  - `generate`: バリデーション(goal必須)、contextがURLならHTTP GETで本文取得（5s、20KB、失敗時警告メッセージ付与）。OpenAI APIへPOST、JSON応答から questions / actions.do / actions.dont を抽出。解析失敗時はデフォルト質問でフォールバック。結果と警告を返却し、`sales_ai_coach_sessions` に保存。
  - `buildSystemPrompt`: デフォルト観点をベースに、最新の `sales_ai_coach_settings.base_prompt` を追記（ベースは残す）。
  - `settings/updateSettings`: 設定画面表示/保存。`authorizeManager` でユーザID 3,8 以外は403。
  - `guide`: 使い方ページ表示。
- プロンプト:
  - 返却形式: `{"questions":[{"title":"","body":""},...],"actions":{"do":["..."],"dont":["..."]}}`
  - ドメイン観点: 帳票/印刷、承認/権限、在庫/購買、請求/会計(MF連携含む)、非機能/運用。
  - 目標が曖昧ならスコープを絞る質問を含める指示。
- モデル/テーブル:
  - `SalesAiCoachSession`（`database/migrations/2025_03_20_000000_create_sales_ai_coach_sessions_table.php`）
  - `SalesAiCoachSetting`（`database/migrations/2025_12_05_000002_create_sales_ai_coach_settings_table.php`）
  - 最新の設定1件のみ参照（履歴として蓄積）。

## フロントエンド仕様
- メイン: `resources/js/Pages/SalesAiCoach/Index.jsx`
  - goal/context入力、リライト入力、質問表示（チェックボックス＋追記入力フィールドは現状簡易表示）、やる/やらない・未決事項入力。
  - AI応答の do/dont をテキストエリアへ自動反映。コンテキストURLはサーバ側で展開。
  - 印刷: アジェンダカードに `.print-area` を付与し、印刷時はアジェンダのみ出力。ログインユーザ名と日付を印刷ヘッダに表示。
  - 次アクションは訪問前には表示しない（削除済み）。
- ガイド: `resources/js/Pages/SalesAiCoach/Guide.jsx`
  - 要件定義の説明（機能/非機能、レストラン例）、使い方タイムライン、リライトのコツ、ショートカット。
- 設定: `resources/js/Pages/SalesAiCoach/Settings.jsx`
  - ベースプロンプトに追記するカスタム指示を保存（デフォルト表示も確認可）。

## デフォルト質問セット（fallback用）
- ゴールの具体化 / 不明点の洗い出し / 関係者・影響範囲 / 現状と課題 / 制約・前提 / 次アクションと担当。
- キーワードマッチでスコアリングし、上限なしで並べる（0件なら全件から上位）。

## 注意事項
- OpenAIキー未設定時はテンプレ質問で返却し、メッセージに理由を含める。
- コンテキストURL取得失敗時は警告を返しつつ、元テキストでAI呼び出し。
- 設定画面はユーザID 3,8（守部幸洋/川口大希）のみアクセス可。ヘッダーの「設定」ボタン表示も同一判定。
- RAG未実装。将来導入時はコンテキストフェッチと競合しないように設計する。

## デプロイ/マイグレーション
- CI: GitHub Actions `.github/workflows/deploy.yml` で dev/main へ push 時に rsync + `php artisan migrate --force --seed` 実行。
- 新テーブルがあるため初回は `php artisan migrate` が必須。

## 今後の拡張案
- RAGで過去議事録検索を自動付与。
- 質問チェックリストの保存・編集履歴。
- 印刷用アジェンダへの次アクション（訪問後記入）入力欄の別画面対応。
