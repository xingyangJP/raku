# 見積管理 × 予実管理 改修計画

## 背景
- これまでの「見積一覧」は承認状態に応じた枚数・金額を確認する UI だが、経営層は「予算 vs 実績」を一目で把握したい。
- 既存のカード（総見積金額 / 承認済み件数 / ドラフト / 総件数）では予実の観点が不足。
- 承認済み見積の中でも「注文確定したもの」を切り分け、実績金額として別集計する必要がある。

## 要件概要
1. **予算 = 全見積合計**
   - ステータスが `sent` / `pending` / `draft` など全件の合計を予算とする。
   - カード表示例: 「予算（見積合計） ￤ ¥XX,XXX」
2. **実績 = 注文確定済み見積の合計**
   - 新フラグ `is_order_confirmed` を見積モデルに追加。
   - 承認完了後、編集画面で「注文確定」を ON にできる（チェックボックス）。
   - フラグ ON の見積金額を実績として集計。
3. **ドラフトカード廃止**
   - モックの黄色カード（ドラフト件数）は非表示。
   - 代わりに「注文確定件数」「確定率」等、予実に即したカードへ差し替える。

## データモデル変更
| 項目 | 内容 |
| --- | --- |
| `estimates.is_order_confirmed` | boolean, default false, nullable?→false。マイグレーションで追加。 |
| `Estimate` モデル | `$casts` に `is_order_confirmed => 'boolean'` を追加。 |
| フロント | Edit 画面（`Create.jsx`）でトグル（承認済みのみ有効）を表示。 |

## UI/UX 変更
1. **集計カード（2 行構成）**
   - 1 行目  
     - 予算（見積合計）: フィルタ後の `total_amount` を合算  
     - 実績（注文確定）: `is_order_confirmed` が true の見積合計  
     - 実績率: 実績 ÷ 予算 × 100%  
     - 注文確定件数: `is_order_confirmed` 件数
   - 2 行目  
     - 予算（粗利合計）: 全見積の粗利（明細金額 − 原価）の合計  
     - 実績（粗利合計）: 注文確定見積の粗利合計  
    - 受注工数: 注文確定見積の `qty` 合計（人月/人日相当）  
     - 空き枠: 将来の KPI 用（例: 受注残 or ドラフト件数）
2. **フィルタ**
   - 現行の期間/ステータスフィルタを踏襲。期間絞り込みは `issue_date` or `billing_date` の要確認。
   - 注文確定フラグでの絞り込み（確定のみ / 未確定のみ）を追加検討。
3. **注文確定フロー**
   - ステータスが `sent` になった見積のみ、ヘッダ右上の「受注確定」ボタンで確定可。確定済みは「受注取消」表示。
   - 確定時/解除時に確認モーダルを表示し、承認者 + Google Chat へ通知。
   - 保存後に一覧の実績カードへ即時反映。

## API/バックエンド
- `EstimateController@update` に `is_order_confirmed` のバリデーション・保存処理（`boolean`）。
- 見積一覧 API（`EstimateController@index`）でカード表示用の集計値（予算・実績）を追加計算。
- `is_order_confirmed` をフロントへ渡し、`Create.jsx` と `/quotes` のカード描画へ反映。

## バックログ反映
- 新タスク `KCSSYSTEM-27` などで「見積/予実管理統合」を登録。内容: モックのドラフトカード削除、予算/実績カード、注文確定フラグ・トグル追加。

## 実装ステップ
1. **マイグレーション**: `php artisan make:migration add_is_order_confirmed_to_estimates`。
2. **モデル/シーダ更新**: `Estimate::$fillable` / `$casts` に追加。既存データは全て false で初期化。
3. **コントローラ**: `update` + `store` + `index` で `is_order_confirmed` を扱う。
4. **フロント**: Create/Edit 画面にトグル、Quotes カードの再デザイン。
5. **テスト**: L-06（却下）、予実の新シナリオ（受注確定ボタン／カード計算）を README_ESTIMATE_TEST に追記。
