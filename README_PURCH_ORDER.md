# 注文書（Purchase Order）機能 設計メモ

## 1. 背景と目的
- 見積書の承認後、**クライアントが弊社へ発注した体裁の注文書を社内で作成し、押印依頼ができる印刷用HTML** を提供する。
- PDF生成は行わず、ブラウザの印刷機能（PDF出力含む）でレイアウト崩れなく印刷できることをゴールとする。

## 2. 業務フローの整理
1. 弊社（熊本コンピュータソフト株式会社）が見積書を作成し提出。
2. クライアントが見積内容に合意し、発注の意思表示。
3. **弊社がクライアントの代わりに注文書（宛先：弊社）を起票**。
4. 作成した注文書をクライアントに共有し、発注印をもらう。

このため注文書のレイアウトは以下の役割関係を前提とする。
- **御中（宛名）＝弊社名（熊本コンピュータソフト株式会社）**
- **発注者情報＝見積提出先のクライアント情報（会社名・住所・担当者）**

## 3. 対象画面・フロー
- 対象: 見積書編集画面（`/estimates/{id}/edit`）。承認済み見積のみ `注文書を印刷` ボタンを表示。
- ボタンクリックで新しいタブを開き、印刷用HTMLプレビュー（`/estimates/{id}/purchase-order/preview`）を表示。
- プレビュー画面は Inertia + React で実装。印刷ボタンはブラウザ標準 UI を利用。

## 4. プレビュー画面仕様
- ページ: `resources/js/Pages/Estimates/PurchaseOrderPreview.jsx`
- データ:
    - `estimate`: 見積情報（クライアント名・住所・担当者・品目等）
    - `company`: 弊社情報（固定値を `buildCompanyProfile()` で取得）
    - `purchaseOrderNumber`: `PO-{見積番号}` を基本とする注文書番号
- レイアウト要点:
    - A4縦、余白 15mm。`@media print` で印刷最適化。
    - ヘッダー左に弊社宛先（御中）、右に弊社情報とロゴ。
    - 発注者セクションにクライアントの社名・住所・担当者名。
    - 明細表は品目、数量、単位、単価、金額を表示。
    - 備考欄: **見積書（社外向け）備考をそのまま表示**。未入力時は定型文。

## 5. バックエンド仕様
- ルート: `GET /estimates/{estimate}/purchase-order/preview`
    - 認証必須、`status === 'sent'` の見積のみ許可。
- コントローラ: `EstimateController@purchaseOrderPreview`
    - `buildCompanyProfile()` で弊社情報を組み立て（`.env` の COMPANY_* を参照、未設定は既定値）。
    - `resolveCompanyLogoUrl()` で `resources/imgs/kcs_logo.png` を Vite アセットとして解決。
    - `generatePurchaseOrderNumberForPreview()` で表示用の注文書番号を生成。
- データ整形（React側）: totals（小計・税額・合計）を算出し、表示フォーマットは `toLocaleString('ja-JP')` を利用。

## 6. UI動線（見積編集画面）
- ボタン表示条件: `isEditMode && is_fully_approved`
- ボタン構成:
    1. `注文書を印刷` → `window.open(route('estimates.purchaseOrder.preview', { estimate: id }))`
    2. `自社請求書に変換`
- 旧PDF生成ボタンは廃止。

## 7. デザイン指針（印刷想定）
- ベースフォント: `Noto Sans JP`, `Yu Gothic`, `Hiragino Sans` など OS 標準日本語フォントを指定。
- 色味: 見積書と統一したブルー系アクセント（#2563eb）を各セクションの見出しに使用。
- 押印欄は注文者（クライアント）が記入する想定のため、スタンプ枠を点線・薄灰色で表示。
- 注文者住所を明示的に出すことで、クライアント情報が漏れなく反映されるようにする。

## 8. テスト観点
- 承認済み以外の見積でアクセス不可（403）であること。
- 承認済み見積で Inertia ページが正しく描画され、注文書番号が `PO-{見積番号}` になること。
- 印刷スタイル確認は手動テスト。必要に応じてE2Eで表示要素の存在を確認。

## 9. 未決事項・今後の拡張
- 注文書番号の正式ルール（例: 日付付加、連番管理）と保存要否。
- クライアント住所／部署情報の取得元（現在は見積に保持されていない場合の扱い）。
- 押印済みのPDF保管フローやメール送付機能の有無。
- 英語版／多言語対応の必要性。

---

本仕様をもとに、印刷用HTMLへ切り替えた注文書機能を実装・改善していく。追加要件が発生した場合は随時更新すること。***
