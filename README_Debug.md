# デバッグ機能の仕様と使用方法
ダイアログUIデザイン
## デザインはtailwindでスタイルを構成しモダンなUIにする
https://ui.shadcn.com/docs/installation/laravel
https://ui.shadcn.com/docs/installation/laravel
## 概要

日本語で話せ

仮定で進めるな。

ファイルを作る時は適切な場所に作って。

React + laravelプロジェクト

# 大前提 MF API利用
顧客テーブル　品目テーブルはMFのスキーマに合わせる
改造中なのでDBが仕様と合ってない可能性がある。旧仕様が残ってたり新仕様のテーブルがなかったり。

https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/get-partners
https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/get-partners-id

# 見積連携系関連
https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/get-partners-id
https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/get-quotes-quote_id
https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/post-quotes-quote_id-convert_to_billing

# 品目マスタ関連
https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/get-items
https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/post-items
https://invoice.moneyforward.com/docs/api/v3/index.html#/operations/get-items-id


# 進捗記録
progress.mdに１ステップ毎進捗を記載して。
記載前に一度読む
結果は「結果を書いて」と言った時だけ記入

# 下記を読んだ後、プロジェクトを調査して実装状況とバグをレポートしろ
README_Dashboard.md          README_Esttimate2MFquote.md  README_quote2bill.md         
README_ESTIMATE.md           README_LOGIN.md              README.md 


# MF連携方法 マネーフォワード クラウド アプリポータルによる他社サービス連携（プログラマー向け）
このガイドは、マネーフォワード クラウドのアプリポータルを利用して他社サービスとAPI連携を行うための基本的な手順と考慮事項を説明しています。プログラマーは、自社のサービスがマネーフォワード クラウドと円滑に連携できるように、以下の情報を参照して実装を進めることができます。
1. 連携の基本的な流れ（ユーザーインターフェースとシステム連携の観点）
連携は、主にユーザーが他社サービス側から操作を開始することで進行します。プログラマーは、このユーザーフローに対応する認証・認可プロセスを実装する必要があります。
1. 他社サービスの画面からの連携開始操作:
    ◦ ユーザーが他社サービスの画面で連携開始の操作（例: ボタンクリック）を行います。
    ◦ プログラマーは、この操作をトリガーとして、マネーフォワード クラウドへの認証・認可フロー（OAuth 2.0などの標準プロトコルが想定されます）を開始する処理を実装します。
2. マネーフォワード IDでのログイン:
    ◦ 「マネーフォワード ID」のログイン画面がユーザーに表示されます。
    ◦ ユーザーはメールアドレスを入力し、利用規約および個人情報の取扱いに同意した上でログインします。
    ◦ 認証が成功した後、マネーフォワード クラウドから指定されたコールバックURLにリダイレクトされるよう、プログラマーはコールバックエンドポイントを用意しておく必要があります。
3. 事業者選択:
    ◦ ユーザーは**「事業者を選択」画面**で、連携したいマネーフォワード クラウドの事業者を選択し、「次へ」をクリックします。
    ◦ このステップで、他社サービスがアクセスする対象の事業者情報が、システムに渡される可能性があります。
4. アプリ連携の許可:
    ◦ 「アプリとの連携を許可しますか？」画面が表示され、ユーザーは連携内容を確認し、「許可」をクリックします。
    ◦ この「許可」により、他社サービスがマネーフォワード クラウドのAPIへの**アクセス権限（アクセストークンなど）**を取得します。プログラマーは、このアクセス権限を受け取り、セキュアに保存・管理する実装を行います。
5. 他社サービスへのリダイレクトと追加手続き:
    ◦ 連携が許可されると、ユーザーは他社サービスの画面に戻されます。
    ◦ 必要に応じて、他社サービス側で追加の連携設定やデータ取得などの手続きを行う場合があります。プログラマーは、連携完了後のUI表示の更新や、取得したアクセストークンを利用した最初のAPI呼び出しなどを考慮する必要があります。
重要な注意点:
• 他社サービスによって画面やボタンの表示、挙動が異なる場合があるため、実装時には柔軟な設計が必要です。
2. プログラマーが考慮すべき権限とエラーハンドリング
連携を成功させるためには、マネーフォワード クラウド側での適切な権限設定と、発生しうるエラーに対する適切な処理が不可欠です。
• 対象となるユーザー:
    ◦ マネーフォワード クラウドのアプリポータルを**「アプリ連携」権限**で利用しているユーザーが連携操作の対象となります。プログラマーは、この権限がユーザーに付与されていることを前提とした連携フローを設計する必要があります。
• 主なエラーリストと対処法: 以下のエラーメッセージは、プログラマーが連携機能のデバッグやユーザーサポートを行う際に非常に役立ちます。
    1. エラーメッセージ: 「●●との連携を許可する権限がありません。」 
        ▪ 原因: アプリポータルでユーザーに**「アプリ連携」権限**が付与されていない。
        ▪ 対処法: アプリポータルの「システム管理」権限を持つユーザーに「アプリ連携」権限をオンにするよう依頼する。
        ▪ プログラマーへの示唆: このエラーが発生した場合、連携機能のUIでユーザーに対して、権限付与を促す具体的なメッセージを表示するなどの対応が考えられます。
    2. エラーメッセージ: 「●●との連携を許可するにはアプリポータルの利用開始手続きが必要です。管理コンソールの全権管理者にご連絡ください｡」 
        ▪ 原因: マネーフォワード クラウドの管理コンソールにおける「全権管理者」が、アプリポータルの利用開始操作を行っていない。
        ▪ 対処法: 管理コンソールの「全権管理者」に、アプリポータルの利用開始操作と、その後ユーザーをアプリポータルに招待してもらうよう依頼する。
        ▪ プログラマーへの示唆: ユーザーが初めて連携を試みる際に発生しうる、組織レベルでの設定不備を示すエラーです。
    3. エラーメッセージ: 「●●との連携を許可するにはアプリポータルの利用開始手続きが必要です｡アプリポータルにログインしてください｡」 
        ▪ 原因: 自身がマネーフォワード クラウドの管理コンソールの「全権管理者」であるが、アプリポータルの利用開始操作がまだ行われていない。
        ▪ 対処法: アプリポータルの利用開始操作を完了させた後、改めて認可操作を行う。
        ▪ プログラマーへの示唆: 特に開発環境やテスト環境で、管理者自身が連携をテストする際に遭遇する可能性のあるエラーです。
    4. エラーメッセージ: 「●●との連携を許可できるユーザーとして登録されていません。」 
        ▪ 原因: アプリポータルのユーザーとして招待・登録されていない。
        ▪ 対処法: アプリポータルの「システム管理」権限を持つユーザーに、アプリポータルのユーザーとして招待してもらい、その後改めて連携操作を行う。
        ▪ プログラマーへの示唆: ユーザー管理に関するエラーであり、ユーザーがアプリポータルにアクセスできるよう設定されているかを確認する必要があります。

このデバッグ機能は、開発中に特定の処理のログを詳細に出力するためのものです。`DEBUG_LOG_ENABLED`環境変数によって、ログ出力の有効/無効を切り替えることができます。これにより、本番環境ではログ出力を停止し、開発環境でのみ詳細なデバッグ情報を得ることが可能になります。

## 設定

デバッグ機能の有効/無効は、`.env`ファイルで`DEBUG_LOG_ENABLED`変数を設定することで制御します。

*   `.env`ファイルに以下の行を追加または変更してください:
    ```
    DEBUG_LOG_ENABLED=true  # デバッグログを有効にする場合
    DEBUG_LOG_ENABLED=false # デバッグログを無効にする場合 (デフォルト推奨)
    ```
    **注意:** `.env`ファイルを変更した後は、`php artisan config:clear`を実行して設定キャッシュをクリアする必要がある場合があります。

*   この設定は、`config/app.php`で`'debug_log_enabled' => (bool) env('DEBUG_LOG_ENABLED', false),`として読み込まれます。

## 使用方法

コード内でデバッグログを出力するには、`\App\Helpers\DebugHelper::logDebug()`静的メソッドを使用します。

```php
<?php

namespace App\Http\Controllers;

use App\Helpers\DebugHelper; // DebugHelperをインポート

class YourController extends Controller
{
    public function someMethod()
    {
        // シンプルなメッセージのログ
        DebugHelper::logDebug('someMethodが実行されました。');

        $data = [
            'user_id' => 123,
            'action' => 'create_record',
            'payload' => ['key' => 'value']
        ];

        // コンテキストデータを含むログ
        DebugHelper::logDebug('データ処理中', $data);

        // ... その他の処理
    }
}
```

*   `logDebug`メソッドは2つの引数を取ります:
    1.  `$message` (string): ログに出力したいメッセージ。
    2.  `$context` (array, オプション): ログに関連する追加のデータ（配列形式）。これはログファイルにJSON形式で出力され、デバッグに役立ちます。

## ログの確認方法

デバッグログは、Laravelの標準ログファイルに出力されます。

*   通常、ログファイルは`storage/logs/laravel.log`に保存されます。
*   ログレベルが`debug`に設定されている場合（`config/logging.php`または`.env`の`LOG_LEVEL`）、`logDebug`で出力されたメッセージがこのファイルに記録されます。
