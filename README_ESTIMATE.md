見積（Estimates）受入テスト仕様（完成版）

目的
 - 見積の作成/編集、承認ワークフロー、一覧・詳細、ダッシュボード「やること」、プレビュー、申請取消の一連動作が、実装済み仕様どおりであることを確認する。

前提・セットアップ（概要）
- PHP 8.2+ / Laravel 12 / Inertia React / MySQL。
- マイグレーション・シーディング・ログイン方法は別紙（ログイン仕様）を参照。

主要仕様（実装済み）
- 一覧の並び順: `issue_date` 降順 → `estimate_number` 降順 → `id` 降順。
- 見積番号採番:
  - 下書き保存時は `EST-D-{staff}-{client}-{yyddmm}-{seq}`。
  - 申請/保存時は `EST-{staff}-{client}-{yyddmm}-{seq}`（空なら自動採番）。
- 明細行と集計:
  - 品目セレクトは「名称のみ」表示（SKU非表示）。選択すると単価・原価を反映。
  - 数量/単位/単価・金額、税区分（標準/軽減/非課税）をサポート。小計・税額・合計を自動計算。
  - 社内ビューでは原価・粗利・粗利率、簡易円グラフを表示。社外ビューでは社内項目は非表示。
 - プレビュー: `/estimates/preview-pdf` にPOSTして新規タブでHTMLプレビュー（社外ビュー準拠）。
- 申請/取消とURL安定化:
  - 作成・更新・申請・再申請・取消後は常に `GET /estimates/{id}/edit` へリダイレクト（リロード405回避）。

承認ワークフロー（実装済み挙動）
- 申請: モーダルで承認者（順序付き）を追加し「申請する」。
  - 申請直後からUIは即「申請取消」を表示（サーバ反映前のローカル表示を含む）。
  - 画面表示の状態: 「承認待ち」バッジ（内部ステータスは `pending`）。各ステップは `approved_at=null` に初期化。
- 再申請: `pending` を指定して更新すると、既存の `approved_at` は全てリセット。
- 取消: 承認フローに未承認が1人でもいる場合は「申請取消」を表示。取消で画面のステータスは「ドラフト」に戻る。
- 承認権限: 現行ステップ担当者のみ承認可（`users.id` または `users.external_user_id` が一致）。
- 完了承認: 全ステップが承認済みになると `status=sent` へ。

再申請の仕様詳細
- 編集画面から「更新して申請」→ダイアログで「申請する」すると必ず初期化（全 `approved_at` が null）。
- ダイアログで承認者を追加・並べ替えした場合: 編集後のフローで初期化。
- ダイアログで承認者を編集しない場合: 既存のフローを保持したまま初期化（フロー自体は維持、`approved_at` のみリセット）。
- 画面表示の状態: 「承認待ち」バッジ（内部ステータスは `pending`）。

ダッシュボード「やること」
- 未承認が残る見積が対象。
- 自分が現行承認者: 「確認して承認」。他者が現行承認者: 「{担当者名}さんの承認待ち」。

詳細シート（一覧からのスライド表示）
- 承認履歴に各ステップを表示。現行=自分の行の左肩に黒ボタン「承認する」を表示（他者には非表示）。

一括操作（一覧）
- 複数選択→「承認申請」: 選択分の `status` を `sent` に更新（簡易動作）。
- 「担当者付替」は現状プレースホルダー（UIのみ）。

受入テスト（推奨シナリオ）
1) 新規作成→申請
   - 基本情報と明細3行以上を入力→［承認申請］。
   - 期待: 「承認申請を開始しました」表示、フッターが「申請取消」に切替。ステータス表示は「承認待ち」。`/estimates/{id}/edit` に遷移し、リロードしても取消表示が維持。
2) 申請取消
   - 期待: 画面のステータス表示が「ドラフト」に戻り、ボタンが「更新して申請」に戻る。
3) 自分が現行の承認
  ```markdown
  見積（Estimates）受入テスト仕様（完成版）

  目的
   - 見積の作成/編集、承認ワークフロー、一覧・詳細、ダッシュボード「やること」、プレビュー、申請取消の一連動作が、実装済み仕様どおりであることを確認する。

  前提・セットアップ（概要）
  - PHP 8.2+ / Laravel 12 / Inertia React / MySQL。
  - マイグレーション・シーディング・ログイン方法は別紙（ログイン仕様）を参照。

  主要仕様（実装済み）
  - 一覧の並び順: `issue_date` 降順 → `estimate_number` 降順 → `id` 降順。
  - 見積番号採番:
    - 下書き保存時は `EST-D-{staff}-{client}-{yyddmm}-{seq}`。
    - 申請/保存時は `EST-{staff}-{client}-{yyddmm}-{seq}`（空なら自動採番）。
  - 明細行と集計:
    - 品目セレクトは「名称のみ」表示（SKU非表示）。選択すると単価・原価を反映。
    - 数量/単位/単価・金額、税区分（標準/軽減/非課税）をサポート。小計・税額・合計を自動計算。
    - 社内ビューでは原価・粗利・粗利率、簡易円グラフを表示。社外ビューでは社内項目は非表示。
   - プレビュー: `/estimates/preview-pdf` にPOSTして新規タブでHTMLプレビュー（社外ビュー準拠）。
  - 申請/取消とURL安定化:
    - 作成・更新・申請・再申請・取消後は常に `GET /estimates/{id}/edit` へリダイレクト（リロード405回避）。

  承認ワークフロー（実装済み挙動）
  - 申請: モーダルで承認者（順序付き）を追加し「申請する」。
    - 申請直後からUIは即「申請取消」を表示（サーバ反映前のローカル表示を含む）。
    - 画面表示の状態: 「承認待ち」バッジ（内部ステータスは `pending`）。各ステップは `approved_at=null` に初期化。
  - 再申請: `pending` を指定して更新すると、既存の `approved_at` は全てリセット。
  - 取消: 承認フローに未承認が1人でもいる場合は「申請取消」を表示。取消で画面のステータスは「ドラフト」に戻る。
  - 承認権限: 現行ステップ担当者のみ承認可（`users.id` または `users.external_user_id` が一致）。
  - 完了承認: 全ステップが承認済みになると `status=sent` へ。

  再申請の仕様詳細
  - 編集画面から「更新して申請」→ダイアログで「申請する」すると必ず初期化（全 `approved_at` が null）。
  - ダイアログで承認者を追加・並べ替えした場合: 編集後のフローで初期化。
  - ダイアログで承認者を編集しない場合: 既存のフローを保持したまま初期化（フロー自体は維持、`approved_at` のみリセット）。
  - 画面表示の状態: 「承認待ち」バッジ（内部ステータスは `pending`）。

  ダッシュボード「やること」
  - 未承認が残る見積が対象。
  - 自分が現行承認者: 「確認して承認」。他者が現行承認者: 「{担当者名}さんの承認待ち」。

  詳細シート（一覧からのスライド表示）
  - 承認履歴に各ステップを表示。現行=自分の行の左肩に黒ボタン「承認する」を表示（他者には非表示）。

  一括操作（一覧）
  - 複数選択→「承認申請」: 選択分の `status` を `sent` に更新（簡易動作）。
  - 「担当者付替」は現状プレースホルダー（UIのみ）。

  受入テスト（推奨シナリオ）
  1) 新規作成→申請
     - 基本情報と明細3行以上を入力→［承認申請］。
     - 期待: 「承認申請を開始しました」表示、フッターが「申請取消」に切替。ステータス表示は「承認待ち」。`/estimates/{id}/edit` に遷移し、リロードしても取消表示が維持。
  2) 申請取消
     - 期待: 画面のステータス表示が「ドラフト」に戻り、ボタンが「更新して申請」に戻る。
  3) 自分が現行の承認
     - 期待: 該当行が承認済みになり日付表示、次の承認者が現行に。全承認後は `sent`。
  4) 他人の承認不可
     - 期待: ボタン非表示、または「現在の承認ステップの担当者ではありません。」エラー。
  5) 取消表示ルール
     - 期待: 3人フローで1人承認済・2人目未承認・3人目待機中でも「申請取消」が表示されること。
  6) 一覧の並び安定性
     - 期待: `issue_date`→`estimate_number`→`id` の降順で安定。
  7) 品目セレクト
     - 期待: 名称のみ表示、既存見積では `product_id` に一致して初期選択されること。
  8) 詳細シートの承認UI
     - 期待: 現行=自分の行にのみ「承認する」ボタン、承認済み行に承認日。
  9) ダッシュボード
     - 期待: 「確認して承認」または「{承認者名}さんの承認待ち」表示で遷移可能。
  10) プレビュー
     - 期待: 新規タブで社外ビューのレイアウトが表示（原価等は非表示）。
  11) 複製
     - 一覧から複製→編集画面に遷移。画面のステータスは「ドラフト」、採番はドラフト形式。

  補足
  - E2EはUI操作を前提に画面遷移と要素の状態で判定する。

  操作手順（UI）
  - 新規作成:
    - 見積管理: `/quotes` → 右上「新規見積」をクリック（ヘッダー内ボタン）。
    - 顧客名: 「顧客を選択...」ボタンをクリック → 検索欄（プレースホルダ「顧客を検索...」）が出る → 候補から選択。
    - 自社担当者: 「担当者を選択...」→ 候補から選択。
    - 件名: 件名入力欄に例として「システム販売自動テスト001」を入力。
    - 発行日/有効期間: `#issue-date` / `#due-date` に日付入力。
    - 明細の追加: 「行を追加」→ 行が増える。
      - 品目: 行内の「品目を選択」をクリック → 候補から選択（名称のみ表示）。選択すると単価/原価が自動反映。
      - 数量: 行内の数量入力（数値）。
      - 単位: 行内の単位入力（3文字まで）。
      - 税区分: 行内セレクトから「標準/軽減/非課税」。
    - 社内ビュー切替: 右上トグル「社内ビュー」で原価・粗利を表示/隠す。
    - 承認申請: 画面右下の「承認申請」を押下 → ダイアログ「承認申請」。
      - 承認者: 「承認者を追加…」で候補から追加。上下ボタンで並べ替え、ゴミ箱で削除。
      - 実行: 「申請する」→ 「承認申請を開始しました」が表示され、フッターが「申請取消」に切替。画面は `/estimates/{id}/edit` にいる。

   - 編集/再申請:
    - 見積管理: 行右端の「…」→「編集」で `/estimates/{id}/edit` を開く。
    - 内容変更: 基本情報・明細は新規作成と同じ操作。並びと集計は自動更新。
    - 再申請: 右下「更新して申請」→ ダイアログで承認者を必要に応じて追加/並び替え → 「申請する」。既存の承認は初期化され、画面上のステータスは「承認待ち」。
    - 申請取消: 「申請取消」を押下 → 確認OK → フッターが「更新して申請」に戻り、ステータスは「ドラフト」。

  画面別シナリオ
  -- ダッシュボード（/dashboard）
    - 表示条件: 承認フローに未承認が残る見積がカードとして表示される。
      - 自分が現行承認者: カードに「確認して承認」ボタン。
      - 他者が現行承認者: 「{承認者名}さんの承認待ち」ラベル。
    - 操作: 「確認して承認」→ 詳細モーダル相当の画面へ遷移/表示 → 現行=自分なら「承認する」ボタンで承認可能。
    - 期待: 承認すると次の承認者が現行に更新。全承認でカードから消え、一覧では「承認済」。

  -- 見積一覧（/quotes）
    - 並び順: 発行日↓ → 見積番号↓ → ID↓。
    - 行の操作（…メニュー）:
      - 詳細を見る: スライドシート表示。承認履歴・明細サマリ・統計。
      - 編集: `/estimates/{id}/edit` へ。
      - 複製: 新規ドラフトを作成し編集画面へ。
      - プレビュー: 新規タブで社外ビューHTML。
      - 削除: 確認後に削除。
    - 一括操作: チェック → 「承認申請」「担当者付替（ダミー）」。
    - 期待: 詳細シート内でも、現行=自分の行にのみ「承認する」ボタンが表示され承認可能（ダッシュボード同等）。

  -- 詳細シート（一覧から）
    - 承認履歴: 承認済=日付表示、最初の未承認=「承認待ち」、以降=待機。
    - 操作: 現行=自分なら「承認する」→ 次の承認者が現行に。
    - 期待: 全承認でステータスは「承認済」。

  -- 作成/編集（/estimates/create・/estimates/{id}/edit）
    - 上述の操作手順に準拠。申請後は常に編集画面（GET）にとどまり、リロードしても405にならない。
    - 申請直後はモーダルに「承認申請を開始しました」を表示し、フッターは「申請取消」。

  -- プレビュー
    - 画面の内容を社外ビューでHTML表示（別タブ）。原価・粗利等は出力しない。

  ```

  ---
  追加: E2E テスト - 見積作成→編集

  簡易テストファイル: `e2e/estimate-create-edit.spec.ts`

  シナリオ概要:
  - 見積一覧 `/quotes` から「新規見積」フローを実行（存在しない場合はテストが DOM を注入してフローを模擬）。
  - 件名・顧客・明細1行を入力し、申請（テストでは `/estimates/{id}/edit` へ遷移させる）。
  - 編集画面で申請済表示（`承認申請を開始しました` または `申請取消` ボタン）を確認。

  実行方法:
  ```bash
  # 単体実行（ヘッデッドで確認したい場合）
  npx playwright test e2e/estimate-create-edit.spec.ts --project=chromium --headed

  # 全体実行の一部として
  npx playwright test e2e/estimate-create-edit.spec.ts
  ```

  注意:
  - このテストはアプリのフル機能を想定していません。UI が存在しない環境では要素注入で動作を模擬します。
  - より正確な E2E を望む場合はアプリ側に `data-testid` 等のフックを追加するか、API をモックする手法に切り替えてください。
