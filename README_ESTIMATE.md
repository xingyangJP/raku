1. 画面構成（共通）
	•	ページタイトル：見積書
	•	上部バー：検索/フィルタ（折りたたみ可）・［新規見積］・［CSV/Excel出力］・［PDFプレビュー］・［列設定］
	•	一覧テーブル：固定ヘッダ・列ON/OFF・横スクロール・行クリックで右ドロワー詳細
	•	右ドロワー：概要／明細／内訳（原価・粗利）／承認履歴／添付
	•	キーボード：/検索、n新規、Enter詳細、pPDF

⸻

2. フィルタ（上部・折りたたみ可）
	•	キーワード（見積番号／件名／顧客名）
	•	期間（作成日／有効期限）
	•	ステータス（ドラフト／承認待ち／承認済／失注／受注化済）
	•	担当者／部門
	•	粗利率しきい値（例：＜20%）
	•	保存ビュー（例：今月の承認待ち）

⸻

3. 一覧テーブル（デフォルト列）
	•	見積番号（リンク）
	•	件名（案件名）
	•	顧客名／顧客担当
	•	小計（税抜）
	•	税額／税込合計
	•	社内専用：原価合計／粗利額／粗利率（権限で表示、エクスポート/印刷時は自動非表示）
	•	ステータス／有効期限
	•	担当者／最終更新

一括操作：承認申請／ステータス変更／

⸻

4. 新規・編集（見積エディタ）

4.1 ヘッダ（基本情報）
	•	見積番号（自動採番/手動可）
	•	件名（案件名）
	•	顧客（名称・部署・担当・請求先）（別途DBのテーブル参照）
	•	見積日／有効期限
	•	通貨／税区分（外税/内税/非課税）・税率
	•	支払条件／納期／納入場所
	•	備考（社内メモ／対外メモを分離）

4.2 明細グリッド

列（社外出力対象）
	•	行種別：労務（人日）／製品（ハード）／ソフト（固定価格）／その他／割引
	•	品目名／型番・規格
	•	数量／単位
	•	単価（売価）／金額（=数量×単価）
	•	小計グループ（任意：セクション見出し）
	•	オプションフラグ（選択式見積）

列（社内専用：表示のみ・出力時非表示）
	•	人日（労務行のみ）：人日数
	•	人日単価（原価）：設定マスターから自動参照（職位/グレード別）
	•	原価単価（製品/仕入物）
	•	原価金額（= 原価単価×数量 or 人日×人日原価）
	•	粗利額（= 売価金額 − 原価金額）
	•	粗利率（= 粗利額 / 売価金額）
	•	リスクバッファ％（任意・社外非表示）

行操作：行追加／複製／削除／上へ下へ／小計行挿入／税区分個別指定
バリデーション：数量>0、金額≧0、労務行は人日必須、割引は負値OK（上限％ルール可）

4.3 内訳・集計（右サイドパネル）
	•	小計（税抜）／消費税／合計（税込）
	•	社内：原価合計／粗利額／粗利率（全体・グループ別）
	•	内訳円グラフ（労務vs製品）※社内のみ
	•	しきい値アラート（粗利率＜設定値で警告表示）

4.4 ボトムバー（アクション）
	•	［下書き保存］［承認申請］［複製］［PDFプレビュー］［受注化］
	•	表示切替：社内/社外ビュー（トグル）…切替で社内項目を全面マスク
	•	変更履歴（差分表示）

⸻

5. 人日計算と単価マスター

5.1 設定画面（/settings/rates）
	•	人日単価マスター
	•	職位/グレード（例：SE、PG、PM）
	•	人日原価（社内原価）／人日売価（推奨）
	•	休日/深夜係数・現地常駐係数（任意）
	•	適用開始日（履歴管理）
	•	計算ルール
	•	1人日=8h（変更可）
	•	端数処理（0.25刻み、四捨五入/切上/切下）
	•	権限：編集権限を限定、変更履歴保存

5.2 自動計算（労務行）
	•	金額（売価）= 人日 ×（人日売価）
	•	原価金額 = 人日 ×（人日原価）
	•	係数がある場合：売価/原価に係数を乗算

⸻

6. ソフト/ハードの粗利の見せ方
	•	労務（ソフト開発）：**人件費（原価）**で粗利算出（別途DBのテーブル参照）
	•	製品（ハード/仕入）：仕入原価で粗利算出
	•	UI上は行種別ごとに 粗利ピル表示（社内のみ）：
	•	緑：30%以上、橙：15–30%、赤：＜15%（閾値は設定可能）

⸻

7. PDF/印刷（社外出力）プレビュー画面にボタン配置
	•	社内項目は完全非表示：原価・粗利・人日・係数・社内メモ・内訳グラフなど
	•	表紙：見積番号・件名・顧客・作成日・有効期限・合計
	•	明細：行種別・品目・数量・単価・金額・小計（グループ）
	•	条件：支払条件／納期／有効期限／見積有効条件
	•	会社情報・押印欄（任意）
	•	透かし・パスワード付与（設定可）

プレビューは社外ビュー強制。ダウンロード/メール送付ボタンを同画面に配置。

⸻

8. 承認ワークフロー
	•	ステータス：ドラフト → 承認申請 → 承認/差戻 → 承認済
	•	承認ルール：金額/粗利率しきい値・部門・担当でルート分岐
	•	履歴：承認者・日時・コメント（右ドロワー「承認履歴」）

⸻

9. バージョン管理
	•	見積 V1, V2…（コピーで作成、最新のみ編集可）
	•	変更差分：価格・原価・行数・粗利推移を比較表示（社内のみ）
	•	PDFはバージョン別に保管

⸻

10. 付随機能
	•	テンプレート：行セット（初期費/月額/保守）を呼び出し
	•	オプション見積：オプション行はチェックで合計に反映/除外
	•	割引：行単位 or 総額％割引（社外表示は割引後金額のみ）
	•	添付：要件定義書・仕様書（PDF/JPG）
	•	見積→受注変換：SO/案件へ引継ぎ（明細コピー、原価は社内のみ）

⸻

11. 権限と秘匿
	•	原価/粗利の表示権限（閲覧ロールのみ）
	•	PDF/CSVは常に社外ビュー
	•	画面トグル「社外ビュー」に切替中は原価UI要素をDOMから除去（CSS隠しではなくレンダリングしない）
	•	監査ログ：原価/単価変更・承認操作は誰がいつ何を

⸻

12. 主要フォーミュラ（参考）
	•	行金額（売価）= 数量 × 単価
	•	行原価 =
	•	労務：人日 × 人日原価
	•	製品：数量 × 原価単価
	•	行粗利額 = 行金額 − 行原価
	•	行粗利率 = 行粗利額 / 行金額
	•	小計（税抜）= Σ 行金額（割引含む）
	•	税額 = 小計 × 税率（行混在時は行ごと計算→合算）
	•	合計（税込）= 小計 + 税額

⸻

13. サーバー環境でのAPIエラーに関するトラブルシューティング

- **事象:**
  - 開発環境では正常に動作するが、Xserver上の本番環境でのみ、顧客情報・担当者情報を取得するAPI（`/api/customers`, `/api/users`）が500 (Internal Server Error) で失敗した。

- **原因:**
  1.  **cURLのバージョン非互換:** サーバーにインストールされているPHPのcURL拡張機能のバージョンが古く（7.29.0）、LaravelのHTTPクライアント（Guzzle）が内部で使用しているTLS 1.2関連の定数（`CURL_SSLVERSION_TLSv1_2`）が未定義であったため、PHPの致命的なエラーが発生していた。
  2.  **強力なサーバーキャッシュ:** ファイルを修正・デプロイしても、サーバー上のOpCacheなどのキャッシュ機構が古いバージョンのファイルをメモリ上に保持し続けていたため、修正が即座に反映されず、問題が解決しない状況が続いた。

- **対応:**
  - **初期対応（パッチ適用）:**
    - 当初、Guzzleのライブラリファイル（`CurlFactory.php`）に直接パッチを当て、古いcURL環境でもエラーを吐かないようにする対応を試みた。
    - しかし、キャッシュの問題によりパッチが正しく適用されているにも関わらずエラーが解消されず、原因の切り分けが困難を極めた。
  - **最終対応（Guzzleの回避）:**
    - 問題の根本的な切り分けと、サーバー環境に依存しない安定動作を確保するため、Guzzleの使用を完全にやめる方針に転換。
    - `ApiController.php`内のHTTPリクエスト処理を、Laravelの`Http`ファサードから、PHP標準の`curl`関数（`curl_init`, `curl_setopt`等）を直接使用するコードに全面的に書き換えた。
    - これにより、GuzzleライブラリとサーバーのcURLバージョンの相性問題を完全に回避し、APIが正常に動作するようになった。
  - **クリーンアップ:**
    - 上記対応に伴い、不要になったパッチファイル（`guzzle.patch`）と、デプロイワークフロー（`.github/workflows/deploy.yml`）内のパッチ適用ステップを削除。
    - キャッシュクリアのために一時的に作成した`opcache_reset.php`もリポジトリとサーバーから削除し、クリーンな状態に戻した。