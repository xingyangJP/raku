# AI見積り機能 改造計画（ドラフト）

> 注: まだ実装しません。この計画をレビューのうえ、OK後に着手します。

## 1. ゴール
- 要件整理フェーズで「情報不足時の質問→前提を明示した仮整理」を自動化し、Markdownフォーマットで安定出力。
- 大幅な要件不足時でも、チャットの往復で不足を埋められるUXを提供（重要ルールをシステムによるガイドで徹底）。
- 整理された要件を見積AIに渡す際の整合性を高め、品目選定ロジックは維持しつつ明細の記述をより詳細化。

## 2. 主要改修の方向性
### 2.1 要件整理機能の改修（チャット拡張）
- **UX案**: 編集画面に「要件整理チャット」セクションを追加。以下を自動化:
  - 入力が不足している場合は最初に「確認したい質問リスト」を箇条書きで提示（重要ルール1）。
  - 質問にユーザーが回答すると、更新されたコンテキストで再度整理案を出力。
  - 現時点で埋まらない項目は「仮の前提です」「今後要確認」と明示（重要ルール2）。
  - 出力は指定のMarkdown章立てで固定（重要ルール3）。プレビューを右ペインで表示。
- **チャット履歴管理**: 要件入力→質問→回答→再整理を1スレッドで扱う。ドラフト採用時に現行の「要件概要・詳細」に反映するが、上書き/追記の選択をUIで明示。
- **安全策**: ペーストした顧客固有情報をローカル保存しないオプション、APIエラー時はローカルテンプレを使ったフォールバック提示。

### 2.2 Markdown出力の整形
- 章立て固定のテンプレートをAIプロンプトに埋め込み、欠損は「不足情報・仮置き前提」に必ず列挙。
- 画面/ユースケース単位の機能要件に、入力・出力・例外・外部連携・未確定を必ず列挙するプロンプトガードを追加。

### 2.3 見積AIとの整合性強化
- 要件チャットの最終整理結果を見積AIに渡す前処理でバリデーション（章立て抜け、必須セクションの空欄チェック）。
- 品目選定とフォーマットは現行ロジックを維持（壊さない）が、明細 description の粒度を上げるため、要件整理結果から「機能名 + 主要ユースケース + 受入れ観点」を抽出して補足文を付与する。
- 品目マッピングが曖昧なときは候補を最大3件まで挙げ、選択肢を提示するモードを追加（自動決定と手動選択を切替可能）。

## 3. 実装ステップ案
1) **プロンプト設計**: 上記重要ルールを組み込んだシステム/ユーザープロンプト雛形を作成。欠損データの質問リスト出力を強制。
2) **チャットUI追加**: 編集画面に要件整理チャットカード＋Markdownプレビュー。履歴は1見積あたり1スレッドで保持。
3) **バックエンドAPI**: 要件チャット用のエンドポイントを新設し、OpenAI呼び出し・ログ記録・エラーフォールバックを実装。
4) **要件データ連携**: チャット採用時に「要件概要/詳細」に書き戻し。元の自由入力欄は残す。
5) **見積AI連携強化**: 整理済み要件の検証＋説明粒度向上の補助プロンプトを追加（品目選定の既存ロジックは変更しない）。
6) **QA/UX確認**: 不足情報→質問→追記→再整理の導線確認。誤入力時のエラー表示とフォールバックを確認。

## 4. リスク・留意点
- 大規模プロンプトになるため、トークンコストと応答遅延に注意。長文はサーバサイドで要約してからAIに渡す。
- 顧客固有情報の扱いを明示し、チャット履歴の保存方針（保存/非保存）を設定。
- Markdown整形崩れ時のフォールバック（章立てテンプレに空欄埋め）を用意。

## 5. 追加で確認したいこと
- チャット履歴の保存: 保存する（保存期間: 永久）。閲覧権限: 内部用。
- チャットの想定閲覧者: 顧客にも見せる前提。口調・詳細度を顧客提示を意識したものに。
- 見積AIへの連携タイミング: 現状と同じフロー（要件整理の最新版を使ってAIドラフト生成→プレビュー→採用/置換）。
